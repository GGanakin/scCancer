---
title: "scCancer2-TMEIdentification"
author: "Zeyu Chen"
date: '2022-09-07'
output: html_document
---

```{r}
rm(list = ls())
gc()
options(stringsAsFactors = F)
```

# Import Packages

```{r}
suppressMessages(library(Seurat))
suppressMessages(library(org.Hs.eg.db))
suppressMessages(library(garnett))
suppressMessages(library(xgboost))
suppressMessages(library(ggplot2))
suppressMessages(library(ggsci))
suppressMessages(library(cowplot))
suppressMessages(library(viridis))
suppressMessages(library(magrittr))
suppressMessages(library(dplyr))
suppressMessages(library(edgeR))
suppressMessages(library(corrplot))
suppressMessages(library(flexclust))
```

```{r}
library(devtools)
load_all()
document()
library(scCancer2)
```

# Training

```{r}
allmodels <- trainAnnoModel(expr,
                            rough.label,
                            fine.label,
                            markers.Path,
                            model.savePath,
                            input.type = "Seurat",
                            gene.method = "Entropy",
                            gene.length = 2000,
                            garnett.cutoff = 0.7,
                            train.ratio = 0.8,
                            repeat.times = 1,
                            umap.visualization = TRUE,
                            confusion.matrix = TRUE,
                            dropout.modeling = FALSE,
                            metacell.anno = FALSE)
```

# scStatistics
## GSE140228:.mtx, .tsv.gz file
```{r}
path <- "D:/scCancer-data/SubtypeAnno/Demo-pipeline/GSE140228/"
matrix <- readMM(paste0(path, "data/ori/matrix.mtx"))
gene.info <- read.table(paste0(path, "data/ori/features.tsv"))[-1,1:2]
generate10Xdata(matrix = matrix,
                gene.info = gene.info, 
                outPath = paste0(path, "data/"))
# add file "barcode.tsv.gz"  manually
```

## GSE146771:.txt file
```{r}
path <- "D:/scCancer-data/SubtypeAnno/Demo-pipeline/GSE146771/"
matrix <- read.table(gzfile(paste0(path, "data/ori/GSE146771_CRC.Leukocyte.10x.TPM.txt.gz")))
saveRDS(matrix, paste0(path, "data/ori/GSE146771_CRC_data.rds"))
```
```{r}
matrix <- readRDS(paste0(path, "data/ori/GSE146771_CRC_data.rds"))
gene.list <- read.table(paste0(system.file("txt", package = "scCancer2"), "/single_cell_features.tsv"))[,1:2]
index <- which(rownames(matrix) %in% gene.list$V2)
matrix.sub <- matrix[index,]
geneset <- gene.list[match(rownames(matrix.sub), gene.list$V2),]
generate10Xdata(matrix = matrix.sub,
                gene.info = geneset, 
                outPath = paste0(path, "data/"))
```

## runScStatistics
```{r}
path <- "D:/scCancer-data/SubtypeAnno/Demo-pipeline/GSE146771/"
dataPath <- paste0(path, "data")
# A path containing the scStatistics results
statPath <- paste0(path, "result")
# The sample name
sampleName <- "GSE146771"
# The author name or a string used to mark the report.
authorName <- "G-Lab@THU"    
# A path used to save the results files
savePath <- paste0(path, "result")

# Run scStatistics
stat.results <- runScStatistics(
    dataPath = dataPath,
    savePath = savePath,
    sampleName = sampleName,
    authorName = authorName
)
```

# scAnnotation

```{r}
# Run scAnnotation(annotation only)
anno.results <- runScAnnotation(
    dataPath = dataPath,
    statPath = statPath,
    savePath = savePath,
    authorName = authorName,
    sampleName = sampleName,
    geneSet.method = "average",
    bool.runDiffExpr = F,
    bool.runCellClassify = F,
    roughlabel.path = file.path(savePath, "rough-labels.RDS"),
    bool.runCellSubtypeClassify = T,
    celltype.list = NULL,
    ct.templates = NULL,
    submodel.path = NULL,
    markers.path = NULL,
    unknown.cutoff = 0.3,
    subtype.umap = T,
    bool.runMalignancy = T,
    bool.intraTumor = F,
    bool.runCellCycle = F,
    bool.runStemness = F,
    bool.runGeneSets = F,
    bool.runExprProgram = F,
    bool.runInteraction = F,
    genReport = T
)
```

