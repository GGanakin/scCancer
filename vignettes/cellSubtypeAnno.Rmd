---
title: "Cell sub-type annotation"
author: "Zeyu Chen"
date: "2023-08-02"
output: html_document
---

```{r}
rm(list = ls())
gc()
options(stringsAsFactors = F)
```

```{r}
suppressMessages(library(scCancer))
suppressMessages(library(dplyr))
```

```{r}
annoPath <- 'D:/scCancer-data/Liver/'
authors <- c("Ma2022", "Zhang2019", "Lu2022", "Xue2022", "Zheng2017",
             "Sun2021", "Liu2023", "Losic2020", "Ma2021")
metadata <- readRDS(file.path(annoPath, "metadata-HCC.RDS"))
```


```{r}
author <- authors[1]
folder.name <- author
expr <- readRDS(file.path(annoPath, folder.name, paste0(author, ".RDS")))
rough.labels <- metadata[[author]]$level1
```


```{r}
default.list <- c("T.cells", "Myeloid.cells", "B.cells", "Fibroblast", "Endothelial")
submodel.path <- system.file("csv", package = "scCancer")
markers.path <- system.file("txt", package = "scCancer")
```

```{r}
t.results <- predCellType(expr@assays[["RNA"]]@data)
expr$Cell.Type <- t.results$type.pred
expr$Cell.Type %>%
            gsub("T.cells.CD4", "T.cells", .) %>%
            gsub("T.cells.CD8", "T.cells", .) -> expr$Cell.Type
celltype.list <- intersect(unique(expr$Cell.Type), default.list)
```

```{r}
folder.name <- author
if(!dir.exists(file.path(annoPath, folder.name))){
    dir.create(file.path(annoPath, folder.name), recursive = T)
}
runCellSubtypeClassify(expr = expr,
                       submodel.path = submodel.path,
                       markers.path = markers.path,
                       savePath = file.path(annoPath, folder.name),
                       celltype.list = celltype.list,
                       dropout.modeling = FALSE,
                       unknown.cutoff = 0.3,
                       umap.plot = F)
```

